name: RDP-Wind11

# هذا الـ Workflow سيعمل يدويًا من واجهة GitHub Actions
on:
  workflow_dispatch:
    inputs:
      rdp_username:
        description: 'اسم المستخدم للوصول إلى RDP (الافتراضي: RDP)'
        required: false
        default: 'RDP'
      rdp_password:
        description: 'كلمة المرور للوصول إلى RDP (اتركها فارغة لإنشاء كلمة مرور عشوائية قوية)'
        required: false
        default: '' # سيتم استخدام "Admin@000" إذا قمت بإدخالها هنا عند التشغيل
      tailscale_hostname_prefix:
        description: 'بادئة لاسم مضيف Tailscale (على سبيل المثال، gh-runner ستصبح gh-runner-<run_id>)'
        required: false
        default: 'gh-runner'

jobs:
  secure-rdp-session:
    runs-on: windows-latest
    # يحدد أقصى وقت للتشغيل. 3600 دقيقة (60 ساعة) كافية لجلسة RDP طويلة.
    timeout-minutes: 3600

    steps:
      - name: Configure Secure RDP Settings
        shell: pwsh
        run: |
          Write-Host "Enabling Remote Desktop and configuring security layers..."
          # 1. تمكين Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force

          # 2. تفعيل NLA (Network Level Authentication) - موصى به للأمان
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 1 -Force # 1 = Enabled (Recommended)

          # 3. تفعيل SSL/TLS لطبقة أمان RDP - موصى به بشدة للتشفير
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 2 -Force # 2 = SSL/TLS (Recommended)

          Write-Host "Configuring Windows Firewall for RDP..."
          # إزالة أي قاعدة موجودة بنفس الاسم لتجنب الازدواجية
          Remove-NetFirewallRule -DisplayName "RDP-Tailscale" -ErrorAction SilentlyContinue

          # إضافة قاعدة جدار حماية للسماح باتصالات RDP الواردة على المنفذ الافتراضي (3389)
          New-NetFirewallRule -DisplayName "RDP-Tailscale" `
                              -Direction Inbound `
                              -Action Allow `
                              -Protocol TCP `
                              -LocalPort 3389 `
                              -Description "Allow RDP traffic for Tailscale connection"

          # [اختياري]: إضافة قواعد للسماح بـ ICMP (Ping) للمساعدة في التشخيص
          New-NetFirewallRule -DisplayName "Tailscale Ping (ICMPv4 Inbound)" `
                              -Direction Inbound `
                              -Action Allow `
                              -Protocol ICMPv4 `
                              -Description "Allow inbound ICMPv4 for Tailscale diagnostics" -ErrorAction SilentlyContinue
          New-NetFirewallRule -DisplayName "Tailscale Ping (ICMPv4 Outbound)" `
                              -Direction Outbound `
                              -Action Allow `
                              -Protocol ICMPv4 `
                              -Description "Allow outbound ICMPv4 for Tailscale diagnostics" -ErrorAction SilentlyContinue

          Write-Host "Restarting Remote Desktop Service..."
          Restart-Service -Name TermService -Force

      - name: Create or Update RDP User Account
        id: create_user
        shell: pwsh
        run: |
          $username = "${{ github.event.inputs.rdp_username }}"
          $inputPassword = "${{ github.event.inputs.rdp_password }}"
          $password = ""

          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
              Write-Host "User '$username' already exists. Updating password..."
              if ($inputPassword -ne "") { $password = $inputPassword }
              else {
                  $password = [System.Web.Security.Membership]::GeneratePassword(16, 4)
                  Write-Host "No password provided, generating a strong random password."
              }
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              Set-LocalUser -Name $username -Password $securePass -AccountNeverExpires
          } else {
              Write-Host "Creating new user '$username'..."
              if ($inputPassword -ne "") { $password = $inputPassword }
              else {
                  $password = [System.Web.Security.Membership]::GeneratePassword(16, 4)
                  Write-Host "No password provided, generating a strong random password."
              }
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              New-LocalUser -Name $username -Password $securePass -AccountNeverExpires
              Write-Host "User '$username' created."
          }

          Write-Host "Adding user '$username' to Administrators and Remote Desktop Users groups..."
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username

          echo "rdp_password=$password" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8
              Write-Host "[$(Get-Date)] RDP Session Active. Waiting..."
              Start-Sleep -Seconds 300
          }
