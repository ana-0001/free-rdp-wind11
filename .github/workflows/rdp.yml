name: RDP-W11

# Ù‡Ø°Ø§ Ø§Ù„Ù€ Workflow Ø³ÙŠØ¹Ù…Ù„ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© GitHub Actions
on:
  workflow_dispatch:
    inputs:
      rdp_username:
        description: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ RDP (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: RDP)'
        required: false
        default: 'RDP'
      rdp_password:
        description: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ RDP (Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù‚ÙˆÙŠØ©)'
        required: false
        default: '' # Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… "Admin@000" Ø¥Ø°Ø§ Ù‚Ù…Øª Ø¨Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§ Ù‡Ù†Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„
      tailscale_hostname_prefix:
        description: 'Ø¨Ø§Ø¯Ø¦Ø© Ù„Ø§Ø³Ù… Ù…Ø¶ÙŠÙ Tailscale (Ø¹Ù„Ù‰ Ø³Ø¨ÙŠÙ„ Ø§Ù„Ù…Ø«Ø§Ù„ØŒ gh-runner Ø³ØªØµØ¨Ø­ gh-runner-<run_id>)'
        required: false
        default: 'gh-runner'

jobs:
  secure-rdp-session:
    runs-on: windows-latest
    timeout-minutes: 21600

    steps:
      - name: Configure Secure RDP Settings
        shell: pwsh
        run: |
          Write-Host "Enabling Remote Desktop and configuring security layers..."
          # 1. ØªÙ…ÙƒÙŠÙ† Remote Desktop
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                             -Name "fDenyTSConnections" -Value 0 -Force

          # 2. ØªÙØ¹ÙŠÙ„ NLA (Network Level Authentication) - Ù…ÙˆØµÙ‰ Ø¨Ù‡ Ù„Ù„Ø£Ù…Ø§Ù†
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "UserAuthentication" -Value 1 -Force # 1 = Enabled (Recommended)

          # 3. ØªÙØ¹ÙŠÙ„ SSL/TLS Ù„Ø·Ø¨Ù‚Ø© Ø£Ù…Ø§Ù† RDP - Ù…ÙˆØµÙ‰ Ø¨Ù‡ Ø¨Ø´Ø¯Ø© Ù„Ù„ØªØ´ÙÙŠØ±
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                             -Name "SecurityLayer" -Value 2 -Force # 2 = SSL/TLS (Recommended)

          Write-Host "Configuring Windows Firewall for RDP..."
          # Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ø§Ø²Ø¯ÙˆØ§Ø¬ÙŠØ©
          Remove-NetFirewallRule -DisplayName "RDP-Tailscale" -ErrorAction SilentlyContinue

          # Ø¥Ø¶Ø§ÙØ© Ù‚Ø§Ø¹Ø¯Ø© Ø¬Ø¯Ø§Ø± Ø­Ù…Ø§ÙŠØ© Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§ØªØµØ§Ù„Ø§Øª RDP Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (3389)
          New-NetFirewallRule -DisplayName "RDP-Tailscale" `
                              -Direction Inbound `
                              -Action Allow `
                              -Protocol TCP `
                              -LocalPort 3389 `
                              -Description "Allow RDP traffic for Tailscale connection"

          # [Ø§Ø®ØªÙŠØ§Ø±ÙŠ]: Ø¥Ø¶Ø§ÙØ© Ù‚ÙˆØ§Ø¹Ø¯ Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ù€ ICMP (Ping) Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØ´Ø®ÙŠØµ
          New-NetFirewallRule -DisplayName "Tailscale Ping (ICMPv4 Inbound)" `
                              -Direction Inbound `
                              -Action Allow `
                              -Protocol ICMPv4 `
                              -Description "Allow inbound ICMPv4 for Tailscale diagnostics" -ErrorAction SilentlyContinue
          New-NetFirewallRule -DisplayName "Tailscale Ping (ICMPv4 Outbound)" `
                              -Direction Outbound `
                              -Action Allow `
                              -Protocol ICMPv4 `
                              -Description "Allow outbound ICMPv4 for Tailscale diagnostics" -ErrorAction SilentlyContinue

          Write-Host "Restarting Remote Desktop Service..."
          Restart-Service -Name TermService -Force

      - name: Create or Update RDP User Account
        id: create_user
        shell: pwsh
        run: |
          $username = "${{ github.event.inputs.rdp_username }}"
          $inputPassword = "${{ github.event.inputs.rdp_password }}"
          $password = ""

          if (Get-LocalUser -Name $username -ErrorAction SilentlyContinue) {
              Write-Host "User '$username' already exists. Updating password..."
              if ($inputPassword -ne "") { $password = $inputPassword }
              else {
                  $password = [System.Web.Security.Membership]::GeneratePassword(16, 4)
                  Write-Host "No password provided, generating a strong random password."
              }
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              Set-LocalUser -Name $username -Password $securePass -AccountNeverExpires
          } else {
              Write-Host "Creating new user '$username'..."
              if ($inputPassword -ne "") { $password = $inputPassword }
              else {
                  $password = [System.Web.Security.Membership]::GeneratePassword(16, 4)
                  Write-Host "No password provided, generating a strong random password."
              }
              $securePass = ConvertTo-SecureString $password -AsPlainText -Force
              New-LocalUser -Name $username -Password $securePass -AccountNeverExpires
              Write-Host "User '$username' created."
          }

          Write-Host "Adding user '$username' to Administrators and Remote Desktop Users groups..."
          Add-LocalGroupMember -Group "Administrators" -Member $username
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member $username

          echo "rdp_password=$password" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8

      # ===============================
      # ğŸ“¡ Tailscale Connection Steps (ÙƒÙ…Ø§ Ù‡ÙŠ)
      # ===============================
      - name: Get Latest Tailscale MSI URL
        id: get_tailscale_url
        shell: pwsh
        run: |
          try {
              $releases = Invoke-RestMethod -Uri "https://api.github.com/repos/tailscale/tailscale/releases?per_page=1" -Headers @{ Authorization = "token ${{ secrets.GITHUB_TOKEN }}" }
              $latestRelease = $releases | Select-Object -First 1
              $msiAsset = $latestRelease.assets | Where-Object { $_.name -like "tailscale-setup-*-amd64.msi" }
              if ($msiAsset) {
                  $tsUrl = $msiAsset.browser_download_url
                  Write-Host "Latest Tailscale MSI URL: $tsUrl"
                  echo "ts_url=$tsUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8
              } else {
                  Write-Warning "Could not find latest Tailscale MSI. Using default version."
                  echo "ts_url=https://pkgs.tailscale.com/stable/tailscale-setup-1.66.4-amd64.msi" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8
              }
          } catch {
              Write-Warning "Failed to fetch latest Tailscale release from GitHub API. Using default version."
              echo "ts_url=https://pkgs.tailscale.com/stable/tailscale-setup-1.66.4-amd64.msi" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Ù„Ø¥Ø°Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ GitHub API

      - name: Install Tailscale Client
        shell: pwsh
        run: |
          Write-Host "Downloading Tailscale from ${{ steps.get_tailscale_url.outputs.ts_url }}..."
          $tsUrl = "${{ steps.get_tailscale_url.outputs.ts_url }}"
          $installerPath = "$env:TEMP\tailscale.msi"
          
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          
          Write-Host "Installing Tailscale silently..."
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          
          Write-Host "Tailscale installed. Cleaning up installer."
          Remove-Item $installerPath -Force

      - name: Establish Tailscale Connection
        id: tailscale_connect
        shell: pwsh
        run: |
          Write-Host "Bringing up Tailscale connection..."
          $hostname = "${{ github.event.inputs.tailscale_hostname_prefix }}-$env:GITHUB_RUN_ID"
          
          if ("${{ secrets.TAILSCALE_AUTH_KEY }}" -eq "") {
            Write-Error "TAILSCALE_AUTH_KEY secret is not set. Please add it to your repository secrets."
            exit 1
          }

          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=$hostname --accept-routes --accept-dns
          
          Write-Host "Waiting for Tailscale IP assignment..."
          $tsIP = $null
          $retries = 0
          while (-not $tsIP -and $retries -lt 20) {
              Start-Sleep -Seconds 3
              $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if ($tsIP) {
                  $tsIP = $tsIP.Trim()
              }
              $retries++
          }
          
          if (-not $tsIP) {
              Write-Error "Tailscale IP not assigned after multiple retries. Exiting."
              & "$env:ProgramFiles\Tailscale\tailscale.exe" status
              exit 1
          }
          
          Write-Host "Tailscale IP: $tsIP"
          echo "tailscale_ip=$tsIP" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding UTF8

      - name: Verify RDP Accessibility via Tailscale IP
        shell: pwsh
        run: |
          $tailscaleIp = "${{ steps.tailscale_connect.outputs.tailscale_ip }}"
          Write-Host "Testing RDP connectivity to $tailscaleIp on port 3389..."
          
          $testResult = Test-NetConnection -ComputerName $tailscaleIp -Port 3389 -WarningAction SilentlyContinue
          
          if ($testResult.TcpTestSucceeded) {
              Write-Host "TCP connection to RDP port 3389 on $tailscaleIp successful!"
          } else {
              Write-Error "TCP connection to RDP port 3389 on $tailscaleIp failed."
              Write-Host "Error details:"
              $testResult
              exit 1
          }

      # ===============================
      # ğŸ” Display Info & Maintain Connection
      # ===============================
      - name: Display RDP Credentials and Maintain Connection
        shell: pwsh
        run: |
          $tailscaleIp = "${{ steps.tailscale_connect.outputs.tailscale_ip }}"
          $rdpUser = "${{ github.event.inputs.rdp_username }}"
          $rdpPassword = "${{ steps.create_user.outputs.rdp_password }}"

          Write-Host "`n======================================================="
          Write-Host "            RDP ACCESS INFORMATION"
          Write-Host "======================================================="
          Write-Host "Tailscale IP Address: $tailscaleIp"
          Write-Host "Username: $rdpUser"
          Write-Host "Password: $rdpPassword"
          Write-Host "-------------------------------------------------------"
          Write-Host "Pre-configured Tools:"
          Write-Host "-------------------------------------------------------"
          Write-Host "To connect:"
          Write-Host "1. Install Tailscale on your local machine and log in."
          Write-Host "2. Make sure your Tailscale is connected to the same Tailnet as this runner."
          Write-Host "3. Open Remote Desktop Connection (mstsc.exe on Windows)."
          Write-Host "4. Enter the Tailscale IP Address above."
          Write-Host "5. Use the Username and Password provided."
          Write-Host "======================================================="
          Write-Host "`nWorkflow will remain active for ${{ github.job.timeout_minutes }} minutes."
          Write-Host "To terminate the RDP session, cancel this workflow run manually."

          while ($true) {
              Write-Host "[$(Get-Date)] RDP Session Active. Waiting..."
              Start-Sleep -Seconds 300
          }
